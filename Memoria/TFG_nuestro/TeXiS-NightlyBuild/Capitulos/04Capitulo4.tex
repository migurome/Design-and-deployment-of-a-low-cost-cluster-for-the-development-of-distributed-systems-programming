%---------------------------------------------------------------------
%
%                          Capítulo 4
%
%---------------------------------------------------------------------
\chapter{Configuraci\'on del cluster}

\section{Virtualización del Sistema}
Debido al volumen del material necesario para el desarrollo del proyecto, la necesidad de realizar el montaje y desmontaje de forma manual de éste y la dificultad en el acceso y configuración de cada uno de los nodos que lo componen decidimos invertir tiempo en realizar una virtualización del sistema para minimizar los problemas antes descritos. Así, al disponer de un entorno virtual, que replica el cluster real, se minimiza el tiempo necesario para la configuración de los distintos servicios y servidores del sistema operativo y sirve como banco de pruebas para el desarrollo software.\par

Para ello hemos utilizamos VMware workstation 12 como plataforma de software de virtualización y una ISO de Raspbian basada en Debian Stretch disponible en la página oficial de Raspberry Pi. Aunque el sistema del cluster parte de una versión diferente de debian el sistema de carpetas y sobre todo la instalación de SIMCAN es similar al del entorno real.\par

En el repositorio en github existe una réplica del sistema de carpetas tanto para el servidor como para los nodos slave. Cada una de las carpetas y ficheros modificados en el sistema durante la configuración del sistema quedan reflejados en el repositorio, disponiendo así de un listado en forma de árbol de todas las configuraciones necesarias para el correcto funcionamiento de este.\par


\figurahere{Bitmap/2}{width=.7\textwidth}{fig:2}%
{Estructura en árbol}

\section{Montaje de servidores}
El cluster está dividido en dos partes bien diferenciadas, por un lado, el front-end, donde se dispone de un único servidor, el cual es el único nodo del cluster que tiene instalado el software de SIMCAN además de ofrecer los servicios de NFS, DHCP y SSH entre otros. Éste además es el punto de comunicación con el exterior, al disponer de una tarjeta de red adicional.\par

\figurahere{Bitmap/3}{width=.7\textwidth}{fig:3}%
{Montaje de servidores}

Por otro lado, en el back-end, disponemos de varios nodos slave que disponen únicamente del sistema Debian Jessie y unas pocas librerías necesarias para realizar las operaciones de computo.\par


\section{Dynamic Host Configuration Protocol (DHCP)}
El nodo master hará de servidor repartiendo las  direcciones de forma dinámica al resto de clientes. La red para del back-end es la 172.16.111.0/24, el nodo master tiene asignada de forma manual la dirección 172.16.111.1/24 y hace un reparto con el resto de direcciones del rango.\par
El montaje de DHCP evita tener que asignar manualmente direcciones a todos los nodos, sin embargo es más útil en la práctica que cada uno de los nodos disponga de la misma dirección el máximo tiempo posible, para ello se han modificado el parámetro default-lease-time, que determina el tiempo de concesión de una IP cuando el cliente en su solicitud no lo especifica, del fichero /etc/dhcp/dhcp.conf a sus máximos valores posibles. Estableciendo un valor de 7776000 segundos en dicho campo obtenemos un tiempo de concesión de noventa días. \par

Los servicios ofrecidos por el nodo master de cara al front-end están disponibles a través de su segunda tarjeta de red, configurada para obtener una dirección IP desde un ISP.\par

\figurahere{Bitmap/4}{width=.7\textwidth}{fig:4}%
{Estructura DHCP}

\subsection{Guia paso a paso de instalación de DHCP}
\begin{lstlisting}[language=c]
SERVIDOR: instalación de paquetes

sudo apt-get update
sudo apt-get install isc-dhcp-server

SERVIDOR: editar fichero isc-dchp-server

sudo nano /etc/default/isc-dchp-server
INTERFACES = “eth0”

SERVIDOR: editar fichero interfaces.d

nano /etc/network/interfaces
source-directory /etc/network/interfaces.d

auto eth0	
iface eth0 inet static
address 172.16.111.106
netmask 255.255.255.0
network 192.168.100.0
gateway 172.16.111.105

allow-hotplug wlan0
iface wlan0 inet manual
    wpa-conf /etc/wpa_supplicant/wpa_supplicant.conf

allow-hotplug wlan1
iface wlan1 inet manual
    wpa-conf /etc/wpa_supplicant/wpa_supplicant.conf

SERVIDOR: Editar fichero de configuración /etc/dhcp/dhcpd.conf

Incluir la siguiente configuración al final del fichero:

subnet 172.16.111.0 netmask 255.255.255.0{
	range 172.16.111.106	172.16.111.255;
	option domain-name-servers 8.8.8.8, 4.4.4.4;
	default-lease-time	7776000;
	option routers		172.16.111.105;
}

host Rick{
	hardware ethernet <dir MAC del servidor>
fixed-address 172.16.111.110;
}

SERVIDOR: Activación de la red eth0

sudo ifconfig eth0 up

SERVIDOR: reiniciar

sudo reboot now 

SERVIDOR: Arranque del servicio dhcp
sudo /usr/sbin/dhcpd

SERVIDOR: Comprobación del correcto funcionamiento del sistema

ps -ef | grep dhcpd

SERVIDOR: Muestra de las maquinas conectadas al servicio 

cat /var/lib/dhcp/dhcp.leases 
\end{lstlisting}



\section{Network File System (NFS)}
Como se destacaba anteriormente, el nodo servidor es el único que dispone de una versión de SIMCAN instalada, esta configuración ofrece la posibilidad de que la labor del los nodos slave sea únicamente la de realizar el procesamiento de datos. Mediante NFS, el nodo servidor comparte su carpeta home durante el arranque del sistema, de esta forma, el resto de nodos slave realizan el montaje de este home compartido en red en su propio directorio home, creando así un único punto de acceso compartido en red del que se pueden extraer los ejecutables sin la necesidad de disponer de SIMCAN instalado. El master se encarga de realizar la compilación los ficheros .ned y pone a disposición del resto de nodos los ejecutables.\par

Es necesario que todos los nodos de la red tengan un mismo usuario común para conseguir una correcta sincronización, de igual manera hay que mantener un estricto control de los permisos de cada uno de los nodos slave tanto a nivel interno como de cara al servidor.\par

\subsection{Guia paso a paso de instalación de NFS}
\begin{lstlisting}[language=c]

SERVIDOR: Instalar paquetes

	sudo apt-get update
	sudo apt-get install nfs-kernel-server

SERVIDOR: Editar fichero de configuración "/etc/exports"

	Incluir al final del fichero el directorio a compartir:
	Ruta de carpeta
	Dirección IP de máquina destino / permisos
Ejemplo:
	/home/morty 172.16.111.0/24(rw,no_subtree_check)

CLIENTE: Instalación de paquetes en el cliente 

	Instalados por defecto en raspBian
	sudo apt-get update
	sudo apt-get install build-essential gcc g++ bison flex perl  tcl-dev tk-dev libxml2-dev zlib1g-dev default-jre doxygen graphviz libwebkitgtk-1.0-0 openmpi-bin libopenmpi-dev libpcap-dev

SERVIDOR: Ejecutar cambios realizados

	sudo exportfs -a
	sudo mount 172.16.111.x:/home/morty /home/morty
	172.16.111.x es la dirección ip de servidor

SERVIDOR: Reiniciar servicios 

	sudo /etc/init.d/rpcbind restart
	sudo /etc/init.d/nfs-kernel-server restart

PROBLEMAS:

Permisos desde la maquina cliente:

	El usuario de la máquina cliente ha de ser sudoer
	La carpeta compartida ha de tener todos los permisos chmod -R 0777 scenario
\end{lstlisting}

A fin de evitar tener que realizar el arranque del servidor de forma manual es recomendable crear un daemon he incluirlo en el directorio /etc/init.d para que se ejecute al arranque del sistema de forma automática.\par

\subsection{Creación y lanzamiento de servidor NFS como un daemon del sistema}

Creación del script:
\begin{lstlisting}[language=c]

#!/bin/bash
### BEGIN INIT INFO
# Provides:		M.Romero && D.Quinones
# Required-start:	$syslog
# Required-stop:	$syslog
# Default-Start:	2 3 4 5
# Default-Stop:		0 1 6
# Short-Description:	Inicialización de servicios nfs
# Description:
### END INIT INFO

sudo exportfs -a
sudo /etc/init.d/rpcbind restart
sudo /etc/init.d/nfs-kernel-server restart

# El orden de estos últimos comandos es esencial

Ejemplo de creación de un daemon

chmod +x rickStart.sh
cp rickStart.sh /etc/init.d/
cd /etc/init.d
update-rc.d rickStart.sh defaults
\end{lstlisting}



\subsection{SSH}
\section{Instalaci\'on de SIMCAN}



Antes de poder instalar el software SIMCAN es necesario realizar la instalación previa del simulador modular de eventos discretos de redes Omnet++ en su versión 4.6. Además de la suite Inet, que implementa modelos de código abierto OMNeT++ para redes cableadas, inalámbricas y móviles.\par

Debido a la baja potencia de la Raspberry esta no es capaz de lanzar la aplicación de forma gráfica, esto supone un problema a la hora de realizar la instalación del software. Es por esto que todas las instalaciones han de realizarse de forma manual a través del terminal.\par

Esto afecta principalmente a la instalación de Inet, ya que las principales guías de instalación disponibles en las webs oficiales parten siempre del entorno gráfico de Omnet++.\par

Durante el desarrollo del proyecto hemos generado unas guías de instalación y configuración paso a paso que se desglosarán el el siguiente apartado.\par

\subsection{Gu\'ia paso a paso de instalaci\'on en arquitectura ARM}

\begin{itemize}
\item Descargar los tar.gz de Omnet 4.6, Inet, simcan.tar.
\item Esta última (simcan) incluye las bibliotecas que se necesitan para la compilación.
\item Copia los archivos .tar de Omnet e Inet en /pi y se descomprimen
\item Desde el directorio /pi ejecuta los siguientes comandos
\end{itemize}





\section{Optimizaci\'on y rendimiento}
\subsection{Modificaci\'on del GRUB}
\subsection{Paralelizaci\'on del arranque en servidor}


\section{Seguridad}
\subsection{Eliminaci\'on de usuarios y permisos}

\section{Inicializaci\'on del sistema mediante scripts}


% Variable local para emacs, para  que encuentre el fichero maestro de
% compilación y funcionen mejor algunas teclas rápidas de AucTeX
%%%
%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../Tesis.tex"
%%% End:::::

